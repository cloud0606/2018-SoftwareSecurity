# 防火墙穿透原理学习

> 学号:201611123019

## 1. 防火墙简介

### 1.1 防火墙定义

防火墙就是在两个信任程度不同的网络之间设置的实行网络访问或控制的软硬件保护措施.防火墙能够强化安全策略，能够有效记录因特网上的活动，限制暴露用户点，是一个安全策略检查站.

### 1.2 防火墙发展现状及应用

#### 防火墙发展历程

- 第一 、二代防火墙 

  第一代防火墙始于1985年前后，它几乎与路由器同时出现，由Cisco的IOS软件公司研制.这一代
  防火墙称为**包过滤防火墙**.直到1988年，DEC公司的Jeff Mogul根据自己的研究，才发表了第一篇
  描述有关包过滤防火墙过滤过程的文章.在1989—1990年前后，AT&T贝尔实验室的Dave Presotto和Howard Tfickey率先提出了基于电路中继的第二代防火墙结构，此类防火墙被称为**电路级网关防火墙**.但他们既没有发表描述这一结构的任何文章，也没有发布基于这一结构的任何产品.

- 第三代防火墙

  第三代防火墙结构是在20世纪80年代末和20世纪90年代初由Purdue University的Gene Spafford，
  AT&T贝尔实验室的Bill Cheswick和Marcus Ranum分别研究和开发.这一代防火墙被称为**应用级网**
  **关防火墙**.在1991年，Ranum的文章引起了人们的广泛关注.此类防火墙采用了在**堡垒主机运行代理服务**的结
  构.根据这一研究成果，DEC公司推出了第一个商用产品SEAL.

- 第四代防火墙

  大约在1991年，Bill Cheswick和Steve Bellovin开始了对**动态包过滤防火墙**的研究.1992年，在USC信息科学学院工作的Bob Braden和Annette DeSchon开始研究用于“Visas”系统的动态包过滤防火墙，后来它演变为目前的状态检测防火墙.1994年，以色列的Check Point Software公司推出了基于第四代结构的第一个商用产品.

- 第五代防火墙

  关于第五代防火墙目前尚未有统一的说法，关键在于目前还没有出现获得广泛认可的新技术.一种观点认为，在1996年由 Global Internet Software Group公司的首席科学家Scott Wiegel开始启动的内核代理结构(Kernel Proxy Architecture) 研究计划属于第五代防火墙;还有一种观点认为，在1998年由NAI公司推出的自适应代理(Adaptive Proxy)技术给代理类型的防火墙赋予了全新的意义，可以称之为第五代防火墙.

#### 防火墙分类

目前较为主流的分类方式根据防火墙网络协议栈中的过滤层次不同对防火墙进行分类.一般情况下,防火墙的工作层次越高,所能收集到的信息也就越丰富,就能进行更细粒度的访问控制,但是随之而来的所需分析的数据量就增多,分析性能也随之下降.根据防火墙再网络协议栈中的过滤层次不同,将防火墙分为以下3类:

- 包过滤防火墙,主要参考网络层信息
- 电路级网关防火墙,主要参考传输层协议信息
- 应用级防火墙(代理防火墙),主要参考应用层协议信息

## 2. 防火墙关键技术

防火墙关键技术主要有以下3种:

- 包过滤技术
- 状态检测技术
- 代理服务技术

#### 静态包过滤技术

原理:

​	首先根据安全策略定义一组访问控制规则,对于每个数据包,包过滤技术检查数据包的报头信息,如果在访问控制列表中有对应的项，则依照过滤规则进行过滤,否则应用默认规则.对于每个数据包,主要检查以下信息:

- IP数据包的源 IP 地址、目的 IP 地址、协议类型，选项字段等.

- TCP 、UDP数据包的源端口、目标端口,TCP数据包的标志字段.
- ICMP 类型

优点:

- 包过滤技术对用户来说是完全透明的.由于其主要工作在网络层和传输层,与应用层无关,不需内部网络用户做任何配置，使用起来非常方便.
- 包过滤技术过滤速度快，效率高,对网络性能影响小.

缺点:

- 安全性较低,不能进行数据内容级别的访问控制.
- 规则配置较为复杂,一些应用协议也并不适合用数据报过滤,并且过滤规则的配置比较复杂，容易产生冲突和漏洞.若需要设计严密的访问控制策略,需要管理员认真分析安全策略,还需要严格区分访问控制规则和先后次序,因此规则的配置工作较为复杂.
- 缺少状态感知能力,对于数据包的检测是孤立的、无状态的.

#### 状态检测技术

原理:

​	对于数据包,提取其状态信息,依据状态表进行判断,如果该包属于已经建立的链接状态,则跳过该包直接交至内网主机,若处于未建立连接的状态,则对其进行过滤.

优点:

- 可实现对一些复杂协议建立的临时端口进行有效的管理，状态检测技术为每一个会话连接建立状态信息，并对其维护，利用这些状态信息对数据包进行过滤.动态状态表是状态检测防火墙的核心，利用其可以实现比包过滤防火墙更强的控制访问能力.

缺点:

- 不能进行数据内容级别的控制.
- 增加了内网主机被外部攻击者直接攻击的风险,允许外网主机与内网主机直接连接

#### 代理服务技术

原理:

优点:

- 有效实现内外网络的隔离,内部网络的拓扑、IP 地址等被代理防火墙屏蔽
- 具有强鉴别和细粒度日志能力，支持用户身份识别，可以实现用户级的安全
- 可进行数据内容的检查，实现基于内容的过滤，对通信进行严密的监控

缺点:

- 过滤速度比包过滤器处理速度慢,代理服务的额外处理请求降低了过滤性能
- 需为每一种应用服务编写代理软件模块，提供的服务数目有限.
- 对操作系统的依赖程度高，容易因操作系统和应用软件的缺陷而受到攻击.

## 3. 防火墙穿透技术

防火墙并不是万能的，也有很多防火墙无能为力的地方：

1、防火墙防不住绕过防火墙的攻击.比如，防火墙不限制从内部网络到外部网络的连接，那么，一些内部用户可能形成一个直接通往Internet的连接，从而绕过防火墙，造成一个潜在的backdoor.恶意的外部用户直接连接到内部用户的机器上，以这个内部用户的机器为跳板，发起绕过防火墙的不受限制的攻击.

2、防火墙不是防毒墙，不能拦截带病毒的数据在网络之间传播.

3、防火墙对数据驱动式攻击也无能为力.

因此，我们不能过分依赖防火墙.网络的安全是一个整体，并不是有某一样特别出色的配置.网络安全遵循的是“木桶原理”.

一般防火墙具备以下特点：

1、广泛的服务支持：通过将动态的、应用层的过滤能力和认证相结合，可实现WWW浏览器、HTTP服务器、 FTP等；

2、对私有数据的加密支持：保证通过Internet进行虚拟私人网络和商务活动不受损坏；

3、客户端认证只允许指定的用户访问内部网络或选择服务：企业本地网与分支机构、商业伙伴和移动用户间安全通信的附加部分；

4、反欺骗：欺骗是从外部获取网络访问权的常用手段，它使数据包好似来自网络内部.防火墙能监视这样的数据包并能扔掉它们；

5、C/S模式和跨平台支持：能使运行在一平台的管理模块控制运行在另一平台的监视模块.

### 3.1 目的

​       对防火墙进行探测的目的是要探测出目标网络上是否存在防火墙,并且了解是何种防火墙,进一步探测出防火墙的ACL规则,和防火墙后面的网络拓扑图.一旦攻击者掌握了目标网络的防火墙和网络拓扑等信息,即可进一步分析该网络的特点,找出其攻防中存在的弱点.

### 3.2 防火墙穿透原理

- 欺骗:在配置过程中,防火墙一般会信任端口与应用程序访问互联网,对防火墙所信任的端口、应用程序进行分析 ,伪装自己的互联网行为为防火墙所信任的端口或者应用程序.由此,在发生自身网络行为时,就算是防火墙具有拦截功能,也会错误的认为是合格的网络通信,这样就允许该端口或应用程序通过.

- 规避:实现防火墙基于所挂接的网络接口不同,若相对防火墙而言,网络通信是透明的,则防火墙就不能对其进行拦截. 例如,基于网络用户形态实现防火墙,则相对直接调用核心态接口得以实现的互联网行为,防火墙不能对其拦截.

### 3.3 穿透技术

#### 反弹木马穿透

反弹木马穿透相对比较复杂, 反弹木马外部环境需要有用于穿透的主机和内部反弹木马进行有效的连接. 一般防火墙都是限制从外部到内部的连接,从外部的连接很容易被阻止,所以连接一般从内部环境开始, 在此种情况下防火墙无法辨认连接的安全程度, 因为防火墙对此连接会有误判.这种穿透的缺点是必须要在主机上安装木马.

#### 反向连接技术

客户端主动发起连接,在这种状态下监听端口接收到信息之后开始接受用户的请求.这种连接方式需要由外向内,所以, 防火墙很容易阻止这种连接.反向连接技术就是服务器端想要获得用户的IP地址就需要通过访问第三方来获得, 然后对指定IP地址发起连接请求并且连接.连接由内向外发起,因此较容易通过防火墙

#### HTTP隧道技术

这种隧道穿透技术和VPN原理有很多的相似之处, 将所有要传送的数据全部封装到Http协议里进行传送, 隐藏的位置就是协议分组, 达到穿透防火墙的目的.浏览器访问Web资源都是通过HT TP协议, 信息装到协议中进行传送, 采用HTTP隧道技术的封包也将请求端口设置为80,这种情况下防火墙无法对其真伪进行确认, 检测时便认为是安全的.

#### 端口复用

通过修改套接字属性来实现端口重绑定，这种技术在接受外来数据包的时候通常是由主机进行转化，

#### 共享DNS套接字

使用了dns服务是所有防火墙免疫的功能来实现的，同时DNS套接字句柄技术最大的特点还是采用UDP通信.个人主机需要将数据传输出去时,主机上的防火墙一般都会进行拦截以提醒用户是否与外界进行连接,并且如果我们为自己的进程开一个端口(甚至是新建套接字) ,那么大部分的防火墙都会将其拦截.但对于已经验证的进程则不会去理会,既然防火墙会拦截未验证进程而放行已验证进程的数据传输,那么就将其它进程中允许数据传输的套接字句柄作为自己用来实现对防火墙的穿透.在目标进程的SOCKET不能是TCP,只能是UDP.同时,针对不同系统不同进程也很难定位一个稳定进程SOCKET.我们知道只要一台计算机联上了网络,那么肯定不会被拦截的就是DNS.因为只要连上了互联网,域名解析数据就不会被拦截,因此采用UDP实现.

#### 相关工具

- dnscat2

  dnscat2 支持加密,通过预共享密钥进行身份验证，多个同时进行的会话，类似于 ssh 中的隧道,命令 shell 以及最流行的 DNS 查询类型（TXT，MX，CNAME，A，AAAA）,客户端用 C 语言编写，服务器用 ruby 编写.

- pwnat 

  由于网络环境的限制，大部分计算机都不在公网中，而是位于NAT或者防火墙之后.这时，不同NAT之后的计算机通信就受到限制.为了解决这个问题，Kali Linux提供了一个NAT穿透工具pwnat.该工具首先在公网计算机上建立一个服务端.然后，处于NAT后的其他计算机以客户端模式运行，通过连接服务端，就可以互相访问了.使用该工具，渗透测试人员不需要在NAT路由器上进行设置，就实现了NAT穿透，连接其他NAT后的计算机，形成P2P打洞.

- Ngrok
  [ngrok](https://ngrok.com/) 是一个反向代理，通过在公共端点和本地运行的 Web 服务器之间建立一个安全的通道，实现内网主机的服务可以暴露给外网.ngrok 可捕获和分析所有通道上的流量，便于后期分析和重放，所以ngrok可以很方便地协助服务端程序测试.

- lanproxy

  [lanproxy](https://github.com/ffay/lanproxy)是一个将局域网个人电脑、服务器代理到公网的内网穿透工具，目前仅支持tcp流量转发，可支持任何tcp上层协议（访问内网网站、本地支付接口调试、ssh访问、远程桌面）.

- FCN

  [FCN](https://github.com/boywhp/fcn)[free connect]是一款傻瓜式的一键接入私有网络的工具, fcn利用公共服务器以及数据加密技术实现：在免公网IP环境下，在任意联网机器上透明接入服务端所在局域网网段.支持多种系统，有免费版和付费版.


## 4. 结论

​	信息收集是网络攻击者进行前期准备的重要阶段,如果在这个阶段,攻击者掌握了目标网络的拓扑结构、目标主机的操作系统、防火墙 的 ACL规则等 .则进行下一步的攻击难度就会大大降低.因此深入研究防火墙穿透技术原理,有利于做到进一步防范攻击者,增强网络的安全性.网络穿透技术与反穿透技术, 也诠释了信息安全的本质是对抗.相关技术的发展将是一个不断对抗的过程在对抗中求得发展, 因此需要深入学习研究穿透技术, 以促进提高网络空间的安全。

## 参考

- [NAT穿透工具pwnat](https://www.jianshu.com/p/ce53a3365023)
- [隧道技术之DNS和ICMP与其检测防御](https://www.anquanke.com/post/id/163240#h3-5)
- [实现内网穿透的几款工具](https://my.oschina.net/ZL520/blog/2086061)
- [网络安全课本-第八章 防火墙](https://sec.cuc.edu.cn/huangwei/textbook/ns/chap0x08/main.html)
- 刘波.防火墙穿透技术的研究与实现[D].沈阳工业大学, 2009. 
- 刘福超, 倪佑生, 付素明.个人防火墙穿透技术研究[J].信息安全与通信保密, 2009 (09) :94-95. 
